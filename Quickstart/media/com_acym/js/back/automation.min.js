/**
 * @package    AcyMailing for Joomla
 * @version    6.1.2
 * @author     acyba.com
 * @copyright  (C) 2009-2019 ACYBA S.A.R.L. All rights reserved.
 * @license    GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
 */

jQuery(document).ready(function(t){function a(a){t(".acym__automation__trigger__droppable__"+a).draggable({cursor:"dragging",revert:function(a){if(!a)return t(".acym__automation__droppable__drag").remove(),!0},revertDuration:300,start:function(_,e){t(".acym__automation__user-trigger__"+a).append('<div class="acym__automation__droppable__drag margin-top-1">'+t(e.helper).html()+"</div>")}}),t(".acym__automation__droppable__"+a).droppable({drop:function(i,o){t(".acym__automation__user-trigger__"+a+" .acym__automation__droppable__trigger").length>0&&t(".acym__automation__user-trigger__"+a).append('<div class="acym_trigger_delimiter">'+ACYM_JS_TXT.ACYM_OR+"</div>"),t(".acym__automation__user-trigger__"+a).append('<div class="acym__automation__droppable__trigger margin-top-1"><div class="acym__automation__one__trigger">'+t(o.helper).html()+'</div><i data-trigger-show="'+t(o.helper).attr("data-trigger")+'" class="material-icons acym__color__red acym__automation__delete__trigger cursor-pointer">close</i></div>'),t(".acym__automation__droppable__drag").remove(),t(".acym__automation__all-trigger__"+a).append('<div class="acym__automation__trigger__droppable__'+a+' margin-top-1 cell" style="display: none" data-trigger="'+t(o.helper).attr("data-trigger")+'">'+t(o.helper).html()+"</div>"),t(o.helper).remove(),_(a),e(a)}})}function _(a){t(".acym__automation__user-trigger__"+a+" [data-class]").each(function(){t(this).addClass(t(this).attr("data-class")),t(this).removeAttr("data-class")}),t(".acym__select").select2({theme:"foundation",width:"100%"}),t(".acym__automation__user-trigger__"+a+" [name]").each(function(){t(this).attr("name").includes("stepAutomation")||t(this).attr("name","stepAutomation"+t(this).attr("name"))})}function e(_){t(".acym__automation__delete__trigger").off("click").on("click",function(){$container=t(this).closest(".acym__automation__droppable__trigger"),$previousDelimiter=$container.prev(".acym_trigger_delimiter"),$previousDelimiter.length?$previousDelimiter.remove():$container.next(".acym_trigger_delimiter").remove(),t("[data-trigger="+t(this).attr("data-trigger-show")+"]").show(),$container.remove(),a(_)})}function i(a){var _=t("#acym__automation__filter__"+a+"__options");if(_.length){var e=JSON.parse(_.val());t(".acym__automation__select__"+a+"__filter").off("change").on("change",function(){var _=t("#acym__automation__filters__count__and");_.val(parseInt(_.val())+1),t(this).parent().parent().find(".acym__automation__inserted__filter").remove();var i=e[t(this).val()].replace(/__num-or__/g,t(this).closest(".acym__automation__group__filter").attr("data-filter-number"));i=i.replace(/__num-and__/g,_.val()),t(this).parent().after('<div data-and="'+_.val()+'" class="cell grid-x grid-margin-x grid-margin-y acym__automation__inserted__filter margin-top-1 margin-left-2"><span class="countresults" id="results_'+_.val()+'"></span>'+i+"</div>"),t(".acym__select").select2({theme:"foundation",width:"100%"}),t.setDatePickerGlobal(),t(".switch-label").off("click").on("click",function(){var a=t('input[data-switch="'+t(this).attr("for")+'"]');a.attr("value",1-a.attr("value"))});var n=t(this).closest(".acym__automation__one__filter").find(".acym__automation__filters__operator__dropdown"),l=t(this).closest(".acym__automation__one__filter").find(".acym__automation__filters__fields__dropdown");n.on("change",function(){l.trigger("change")}),l.on("change",function(){var a=t(this).closest(".acym__automation__inserted__filter"),_=a.find('[data-filter-field="'+t(this).val()+'"]'),e=a.find(".acym__automation__filters__fields__select"),i=a.find(".acym__automation__filter__regular-field");_.length>0&&("="===n.val()||"!="===n.val())?(i.attr("name",i.attr("name").replace("acym_action","")).hide(),e.each(function(a){t(this).attr("name",t(this).attr("name").replace("acym_action","")),t(this).closest(".acym__automation__one-field").hide()}),-1===_.attr("name").indexOf("acym_action")&&_.attr("name","acym_action"+_.attr("name")),_.closest(".acym__automation__one-field").show()):(-1===i.attr("name").indexOf("acym_action")&&i.attr("name","acym_action"+i.attr("name")),e.length>0&&e.each(function(){t(this).attr("name",t(this).attr("name").replace("acym_action","")),t(this).closest(".acym__automation__one-field").hide()}),i.show())}).trigger("change"),"classic"===a&&(t(this).closest(".acym__automation__one__filter.acym__automation__one__filter__classic").find(".acym__automation__inserted__filter input, .acym__automation__inserted__filter select").on("change",function(){c(this)}),0==t(this).val()?r(t(this).closest(".acym__automation__group__filter")):c(t(this).closest(".acym__automation__one__filter.acym__automation__one__filter__classic").find(".acym__automation__inserted__filter input, .acym__automation__inserted__filter select"))),t(document).foundation(),t(".reveal-overlay").appendTo("#acym_form"),o()})}}function o(){i("classic"),i("user"),t(".acym__automation__add-filter").off("click").on("click",function(){if(0==t(this).closest(".acym__automation__group__filter").find(".acym__automation__one__filter").length){var a=t("#acym__automation__and__example").clone().removeAttr("id");a.find(".acym__automation__and").remove(),t(this).parent().before(a.show())}else t(this).parent().before(t("#acym__automation__and__example").clone().removeAttr("id").show());var _=t(this).parent().prev();_.addClass("acym__automation__one__filter__"+t(this).attr("data-filter-type")),_.find(".acym__automation__and__example__"+t(this).attr("data-filter-type")+"__select").show().find("select").addClass("acym__select").select2({theme:"foundation",width:"100%"}),o()}),t(".acym__automation__choose__filter").off("click").on("click",function(){t("#acym__automation__type-filter__input").val(t(this).attr("data-filter")),t(".selected-filter").removeClass("selected-filter"),t(this).addClass("selected-filter");var a=t(".acym__automation__filter__container");a.hide(),a.find('[name^="acym_action"]').each(function(a){t(this).attr("name",t(this).attr("name").replace("acym_action",""))});var _=t("#acym__automation__filters__type__"+t(this).attr("data-filter"));_.show(),_.find('[name^="[filters]"]').each(function(a){t(this).attr("name","acym_action"+t(this).attr("name"))})}),t(".acym__automation__filters__or").off("click").on("click",function(){var a=t("#acym__automation__filters__count__or");a.val(parseInt(a.val())+1),t(this).before(t("#acym__automation__or__example").html());var _=t(this).prev();_.attr("data-filter-number",a.val()),o(),_.find("button[data-filter-type]").attr("data-filter-type",t(this).attr("data-filter-type")).click(),"classic"===t(this).attr("data-filter-type")&&r(_)}),t(".acym__automation__delete__one__filter").off("click").on("click",function(){var a=t(this).closest(".acym__automation__group__filter");t(this).parent().parent().remove(),r(a)}),t(".acym__automation__delete__group__filter").off("click").on("click",function(){t(this).parent().parent().prev().remove(),t(this).parent().parent().remove()}),t.setDatePickerGlobal(),t.setRSDateChoice()}function n(){t.setDatePickerGlobal(),t.setRSDateChoice(),function(){var a=t("#acym__automation__actions__json");if(!a.length)return;var _=JSON.parse(a.val());t(".acym__automation__actions__select").off("change.loadoptions").on("change.loadoptions",function(){t(this).parent().parent().find(".acym__automation__inserted__action").remove();var a=_[t(this).val()].option.replace(/__and__/g,t(this).closest(".acym__automation__actions__one__action").attr("data-action-number"));t(this).parent().after('<div class="grid-x acym__automation__inserted__action margin-top-1 margin-left-2 grid-margin-x cell acym_vcenter">'+a+"</div>"),t(".acym__select").select2({theme:"foundation",width:"100%"}),t(document).foundation(),t(".reveal-overlay").appendTo("#acym_form"),n();var e=t(this).closest(".acym__automation__actions__one__action").find(".acym__automation__actions__operator__dropdown"),i=t(this).closest(".acym__automation__actions__one__action").find(".acym__automation__actions__fields__dropdown");e.on("change",function(){i.trigger("change")}),i.on("change",function(){var a=t(this).closest(".acym__automation__inserted__action"),_=a.find('[data-action-field="'+t(this).val()+'"]'),i=a.find(".acym__automation__actions__fields__select"),o=a.find(".acym__automation__action__regular-field");_.length>0&&"="===e.val()?(o.attr("name",o.attr("name").replace("acym_action","")).hide(),i.each(function(a){t(this).attr("name",t(this).attr("name").replace("acym_action","")),t(this).closest(".acym__automation__one-field").hide()}),-1===_.attr("name").indexOf("acym_action")&&_.attr("name","acym_action"+_.attr("name")),_.closest(".acym__automation__one-field").show()):(-1===o.attr("name").indexOf("acym_action")&&o.attr("name","acym_action"+o.attr("name")),i.length>0&&i.each(function(){t(this).attr("name",t(this).attr("name").replace("acym_action","")),t(this).closest(".acym__automation__one-field").hide()}),o.show())}),t(this).closest(".acym__automation__actions__one__action").find(".acym__automation__actions__fields__dropdown").trigger("change")})}(),t(".acym__automation__add-action").off("click").on("click",function(){var a=t("#acym__automation__action__number__action");a.val(parseInt(a.val())+1),t(this).before(t("#acym__automation__example").html());var _=t(this).prev();_.closest(".acym__automation__actions__one__action").attr("data-action-number",a.val()),_.find("select").select2({theme:"foundation",width:"100%"}),n()}),t(".acym__automation__delete__one__action").off("click").on("click",function(){t(this).closest(".acym__automation__actions__one__action").remove()}),t.setSubmitButtonGlobal(),console.log("test"),t(".acym__automation__actions__mails__select").on("change",function(){"0"!==t(this).val()?t(this).closest(".acym__automation__inserted__action").find('[data-task="createMail"]').html(ACYM_JS_TXT.ACYM_EDIT_MAIL):t(this).closest(".acym__automation__inserted__action").find('[data-task="createMail"]').html(ACYM_JS_TXT.ACYM_CREATE_MAIL)})}function c(a){var _=t(a).closest(".acym__automation__group__filter").attr("data-filter-number"),e=t(a).closest(".acym__automation__group__filter"),i=t(a).closest(".acym__automation__inserted__filter").attr("data-and"),o=AJAX_URL_ACYM+"&page=acymailing_automation&ctrl=automation&task=countresults&or="+_+"&and="+i;t("#results_"+i).css("maxHeight","18px").html('<i class="fa fa-circle-o-notch fa-spin"></i>'),t.get(o,t(a).closest("#acym_form").serialize()+"&page=acymailing_automation&ctrl=automation&task=countresults&or="+_+"&and="+i).done(function(a){t("#results_"+i).css("maxHeight","").html(a)}).fail(function(){t("#results_"+i).css("maxHeight","").html(ACYM_JS_TXT.ACYM_ERROR)}),r(e)}function r(a){var _=a.attr("data-filter-number"),e=a.find(".acym__automation__or__total__result"),i=AJAX_URL_ACYM+"&page=acymailing_automation&ctrl=automation&task=countResultsOrTotal&or="+_;e.html('<i class="fa fa-circle-o-notch fa-spin"></i>'),t.get(i,a.closest("#acym_form").serialize()+"&page=acymailing_automation&ctrl=automation&task=countResultsOrTotal&or="+_).done(function(t){e.html(t)}).fail(function(){e.html(ACYM_JS_TXT.ACYM_ERROR)})}t(".acym__automations__filter__tags").select2({theme:"foundation",width:"100%"}),t(".acym__select").select2({theme:"foundation",width:"100%"}),t("#acym__automation__info__desc__button").off("click").on("click",function(){var a=t('[name="automation[description]"]');a.is(":visible")?(a.hide(),t(this).find("i").html("keyboard_arrow_down")):(a.show(),t(this).find("i").html("keyboard_arrow_up"))}),t("#acym__automation__info__choose__trigger__type p").off("click").on("click",function(){t("#acym__automation__trigger__type__input").val(t(this).attr("data-trigger-type")),t(".selected-trigger").removeClass("selected-trigger"),t(this).addClass("selected-trigger"),t(".acym__automation__info__choose__trigger").hide(),t("#acym__automation__info__choose__trigger__"+t(this).attr("data-trigger-type")).show()}),a("classic"),e("classic"),_("classic"),a("action"),e("action"),_("action"),r(t(".acym__automation__select__classic__filter").closest(".acym__automation__group__filter")),o(),function(){var a=t("#filters");if(a.length){var _=JSON.parse(a.val()),e=_.type_filter,i=0;t.each(_,function(a,_){var o=0;if("type_filter"==a)return!0;0!=i&&t('.acym__automation__filters__or[data-filter-type="'+e+'"]').click(),t.each(_,function(a,_){0!=o&&t('.acym__automation__group__filter[data-filter-number="'+i+'"]').find('.acym__automation__add-filter[data-filter-type="'+e+'"]').click(),t.each(_,function(a,_){var o=t('.acym__automation__group__filter[data-filter-number="'+i+'"]').find(".acym__automation__select__"+e+"__filter").last();o.val(a),o.trigger("change"),t.each(_,function(_,e){var o=t('[name="acym_action[filters]['+i+"]["+t("#acym__automation__filters__count__and").val()+"]["+a+"]["+_+']"]');o.is(":checkbox")||null!=o.attr("data-switch")?o.is(":checkbox")&&1==e?o.prop("checked",!0):null!=o.attr("data-switch")&&o.val()!=e&&o.closest(".medium-3").find(".cell.switch-label").click():o.val(e),void 0!==o.attr("data-rs")&&""!==e&&(-1!=e.indexOf("}")?t('input[data-open="'+o.attr("data-rs")+'"]').val(e):t('input[data-open="'+o.attr("data-rs")+'"]').val(moment.unix(e).format("DD MMM YYYY HH:mm"))),o.trigger("change")})}),o++}),i++}),o()}}(),n(),function(){var a=t("#actions");if(a.length){var _=JSON.parse(a.val()),e=0;t.each(_,function(a,_){e>0&&t(".acym__automation__add-action").click(),t.each(_,function(a,_){var i=t(".acym__automation__actions__select").last();i.val(a),i.trigger("change"),t.each(_,function(_,i){var o=t('[name="acym_action[actions]['+e+"]["+a+"]["+_+']"]');o.is(":checkbox")||null!=o.attr("data-switch")?o.is(":checkbox")&&1==i?o.prop("checked",!0):null!=o.attr("data-switch")&&o.val()!=i&&o.closest(".medium-3").find(".cell.switch-label").click():o.val(i),void 0!==o.attr("data-rs")&&""!==i&&(-1!=i.indexOf("}")?t('input[data-open="'+o.attr("data-rs")+'"]').val(i):t('input[data-open="'+o.attr("data-rs")+'"]').val(moment.unix(i).format("DD MMM YYYY HH:mm"))),o.trigger("change")})}),e++})}}()});