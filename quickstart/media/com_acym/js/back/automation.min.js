/**
 * @package    AcyMailing for Joomla
 * @version    6.2.2
 * @author     acyba.com
 * @copyright  (C) 2009-2019 ACYBA S.A.R.L. All rights reserved.
 * @license    GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
 */

jQuery(document).ready(function(t){function a(a){t(".acym__automation__trigger__droppable__"+a).draggable({cursor:"dragging",revert:function(a){if(!a)return t(".acym__automation__droppable__drag").remove(),!0},revertDuration:300,start:function(_,i){t(".acym__automation__user-trigger__"+a).append('<div class="acym__automation__droppable__drag margin-top-1">'+t(i.helper).html()+"</div>")}}),t(".acym__automation__droppable__"+a).droppable({drop:function(o,e){t(this).find(".acym__automation__drag-here-text").remove(),t(".acym__automation__user-trigger__"+a+" .acym__automation__droppable__trigger").length>0&&t(".acym__automation__user-trigger__"+a).append('<div class="acym_trigger_delimiter">'+ACYM_JS_TXT.ACYM_OR+"</div>"),t(".acym__automation__user-trigger__"+a).append('<div class="acym__automation__droppable__trigger margin-top-1"><div class="acym__automation__one__trigger">'+t(e.helper).html()+'</div><i data-trigger-show="'+t(e.helper).attr("data-trigger")+'" class="acymicon-close acym__color__red acym__automation__delete__trigger cursor-pointer"></i></div>'),t(".acym__automation__droppable__drag").remove(),t(".acym__automation__all-trigger__"+a).append('<div class="acym__automation__trigger__droppable__'+a+' margin-top-1 cell" style="display: none" data-trigger="'+t(e.helper).attr("data-trigger")+'">'+t(e.helper).html()+"</div>"),t(e.helper).remove(),_(a),i(a)}})}function _(a){t(".acym__automation__user-trigger__"+a+" [data-class]").each(function(){t(this).addClass(t(this).attr("data-class")),t(this).removeAttr("data-class")}),t(".acym__select").select2({theme:"foundation",width:"100%"}),t(".acym__automation__user-trigger__"+a+" [name]").each(function(){t(this).attr("name").includes("stepAutomation")||t(this).attr("name","stepAutomation"+t(this).attr("name"))})}function i(_){t(".acym__automation__delete__trigger").off("click").on("click",function(){$container=t(this).closest(".acym__automation__droppable__trigger"),$previousDelimiter=$container.prev(".acym_trigger_delimiter"),$previousDelimiter.length?$previousDelimiter.remove():$container.next(".acym_trigger_delimiter").remove(),t("[data-trigger="+t(this).attr("data-trigger-show")+"]").show(),$container.remove(),a(_)})}function o(a){var _=t("#acym__automation__condition__"+a+"__options");if(_.length){var i=JSON.parse(_.val());t(".acym__automation__select__"+a+"__condition").off("change").on("change",function(){var a=t("#acym__automation__conditions__count__and");a.val(parseInt(a.val())+1),t(this).parent().parent().find(".acym__automation__inserted__condition").remove();var _=i[t(this).val()].replace(/__numor__/g,t(this).closest(".acym__automation__group__condition").attr("data-condition-number"));_=_.replace(/__numand__/g,a.val()),t(this).parent().after('<div data-and="'+a.val()+'" class="cell grid-x grid-margin-x grid-margin-y acym__automation__inserted__condition margin-top-1 margin-left-2">'+_+"</div>"),t(".acym__select").select2({theme:"foundation",width:"100%"}),t.setDatePickerGlobal(),t(".switch-label").off("click").on("click",function(){var a=t('input[data-switch="'+t(this).attr("for")+'"]');a.attr("value",1-a.attr("value"))});var o=t(this).closest(".acym__automation__one__condition").find(".acym__automation__conditions__operator__dropdown"),e=t(this).closest(".acym__automation__one__condition").find(".acym__automation__conditions__fields__dropdown");o.on("change",function(){e.trigger("change")}),e.on("change",function(){var a=t(this).closest(".acym__automation__inserted__condition"),_=a.find('[data-condition-field="'+t(this).val()+'"]'),i=a.find(".acym__automation__conditions__fields__select"),e=a.find(".acym__automation__condition__regular-field");_.length>0&&("="===o.val()||"!="===o.val())?(e.attr("name",e.attr("name").replace("acym_condition","")).hide(),i.each(function(a){t(this).attr("name",t(this).attr("name").replace("acym_condition","")),t(this).closest(".acym__automation__one-field").hide()}),-1===_.attr("name").indexOf("acym_condition")&&_.attr("name","acym_condition"+_.attr("name")),_.closest(".acym__automation__one-field").show()):(-1===e.attr("name").indexOf("acym_condition")&&e.attr("name","acym_condition"+e.attr("name")),i.length>0&&i.each(function(){t(this).attr("name",t(this).attr("name").replace("acym_condition","")),t(this).closest(".acym__automation__one-field").hide()}),e.show())}).trigger("change"),t(document).foundation(),t(".reveal-overlay").appendTo("#acym_form"),n()})}}function e(a){var _=t("#acym__automation__filter__"+a+"__options");if(_.length){var i=JSON.parse(_.val());t(".acym__automation__select__"+a+"__filter").off("change").on("change",function(){var _=t("#acym__automation__filters__count__and");_.val(parseInt(_.val())+1),t(this).parent().parent().find(".acym__automation__inserted__filter").remove();var o=i[t(this).val()].replace(/__numor__/g,t(this).closest(".acym__automation__group__filter").attr("data-filter-number"));o=o.replace(/__numand__/g,_.val()),t(this).parent().after('<div data-and="'+_.val()+'" class="cell grid-x grid-margin-x grid-margin-y acym__automation__inserted__filter margin-top-1 margin-left-2"><span class="countresults margin-bottom-1" id="results_'+_.val()+'"></span>'+o+"</div>"),t(".acym__select").select2({theme:"foundation",width:"100%"}),t.setDatePickerGlobal(),t(".switch-label").off("click").on("click",function(){var a=t('input[data-switch="'+t(this).attr("for")+'"]');a.attr("value",1-a.attr("value"))});var e=t(this).closest(".acym__automation__one__filter").find(".acym__automation__filters__operator__dropdown"),n=t(this).closest(".acym__automation__one__filter").find(".acym__automation__filters__fields__dropdown");e.on("change",function(){n.trigger("change")}),n.on("change",function(){var a=t(this).closest(".acym__automation__inserted__filter"),_=a.find('[data-filter-field="'+t(this).val()+'"]'),i=a.find(".acym__automation__filters__fields__select"),o=a.find(".acym__automation__filter__regular-field");_.length>0&&("="===e.val()||"!="===e.val())?(o.attr("name",o.attr("name").replace("acym_action","")).hide(),i.each(function(a){t(this).attr("name",t(this).attr("name").replace("acym_action","")),t(this).closest(".acym__automation__one-field").hide()}),-1===_.attr("name").indexOf("acym_action")&&_.attr("name","acym_action"+_.attr("name")),_.closest(".acym__automation__one-field").show()):(-1===o.attr("name").indexOf("acym_action")&&o.attr("name","acym_action"+o.attr("name")),i.length>0&&i.each(function(){t(this).attr("name",t(this).attr("name").replace("acym_action","")),t(this).closest(".acym__automation__one-field").hide()}),o.show())}).trigger("change"),"classic"===a&&(t(this).closest(".acym__automation__one__filter.acym__automation__one__filter__classic").find(".acym__automation__inserted__filter input, .acym__automation__inserted__filter select").on("change",function(){s(this)}),0==t(this).val()?l(t(this).closest(".acym__automation__group__filter")):s(t(this).closest(".acym__automation__one__filter.acym__automation__one__filter__classic").find(".acym__automation__inserted__filter input, .acym__automation__inserted__filter select"))),t(document).foundation(),t(".reveal-overlay").appendTo("#acym_form"),c()})}}function n(){o("classic"),o("user"),t(".acym__automation__add-condition").off("click").on("click",function(){if(0==t(this).closest(".acym__automation__group__condition").find(".acym__automation__one__condition").length){var a=t("#acym__automation__and__example").clone().removeAttr("id");a.find(".acym__automation__and").remove(),t(this).parent().before(a.show())}else t(this).parent().before(t("#acym__automation__and__example").clone().removeAttr("id").show());var _=t(this).parent().prev();_.addClass("acym__automation__one__condition__"+t(this).attr("data-condition-type")),_.find(".acym__automation__and__example__"+t(this).attr("data-condition-type")+"__select").show().find("select").addClass("acym__select").select2({theme:"foundation",width:"100%"}),n()}),t(".acym__automation__choose__condition").off("click").on("click",function(){t("#acym__automation__type-condition__input").val(t(this).attr("data-condition")),t(".selected-condition").removeClass("selected-condition"),t(this).addClass("selected-condition");var a=t(".acym__automation__condition__container");a.hide(),a.find('[name^="type_condition"]').each(function(a){t(this).attr("name",t(this).attr("name").replace("type_condition",""))});var _=t("#acym__automation__conditions__type__"+t(this).attr("data-condition"));_.show(),_.find('[name^="[conditions]"]').each(function(a){t(this).attr("name","type_condition"+t(this).attr("name"))})}),t(".acym__automation__conditions__or").off("click").on("click",function(){var a=t("#acym__automation__conditions__count__or");a.val(parseInt(a.val())+1),t(this).before(t("#acym__automation__or__example").html());var _=t(this).prev();_.attr("data-condition-number",a.val()),n(),_.find("button[data-condition-type]").attr("data-condition-type",t(this).attr("data-condition-type")).click(),"classic"===t(this).attr("data-condition-type")&&l(_)}),t(".acym__automation__delete__one__condition").off("click").on("click",function(){var a=t(this).closest(".acym__automation__group__condition");t(this).parent().parent().remove(),l(a)}),t(".acym__automation__delete__group__condition").off("click").on("click",function(){t(this).parent().parent().prev().remove(),t(this).parent().parent().remove()}),t.setDatePickerGlobal(),t.setRSDateChoice(),t.setAjaxSelect2()}function c(){e("classic"),e("user"),t(".acym__automation__add-filter").off("click").on("click",function(){if(0==t(this).closest(".acym__automation__group__filter").find(".acym__automation__one__filter").length){var a=t("#acym__automation__and__example").clone().removeAttr("id");a.find(".acym__automation__and").remove(),t(this).parent().before(a.show())}else t(this).parent().before(t("#acym__automation__and__example").clone().removeAttr("id").show());var _=t(this).parent().prev();_.addClass("acym__automation__one__filter__"+t(this).attr("data-filter-type")),_.find(".acym__automation__and__example__"+t(this).attr("data-filter-type")+"__select").show().find("select").addClass("acym__select").select2({theme:"foundation",width:"100%"}),c()}),t(".acym__automation__choose__filter").off("click").on("click",function(){t("#acym__automation__type-filter__input").val(t(this).attr("data-filter")),t(".selected-filter").removeClass("selected-filter"),t(this).addClass("selected-filter");var a=t(".acym__automation__filter__container");a.hide(),a.find('[name^="acym_action"]').each(function(a){t(this).attr("name",t(this).attr("name").replace("acym_action",""))});var _=t("#acym__automation__filters__type__"+t(this).attr("data-filter"));_.show(),_.find('[name^="[filters]"]').each(function(a){t(this).attr("name","acym_action"+t(this).attr("name"))})}),t(".acym__automation__filters__or").off("click").on("click",function(){var a=t("#acym__automation__filters__count__or");a.val(parseInt(a.val())+1),t(this).before(t("#acym__automation__or__example").html());var _=t(this).prev();_.attr("data-filter-number",a.val()),c(),_.find("button[data-filter-type]").attr("data-filter-type",t(this).attr("data-filter-type")).click(),"classic"===t(this).attr("data-filter-type")&&l(_)}),t(".acym__automation__delete__one__filter").off("click").on("click",function(){var a=t(this).closest(".acym__automation__group__filter");t(this).parent().parent().remove(),l(a)}),t(".acym__automation__delete__group__filter").off("click").on("click",function(){t(this).parent().parent().prev().remove(),t(this).parent().parent().remove()}),t.setDatePickerGlobal(),t.setRSDateChoice(),t.setAjaxSelect2()}function r(a,_){if(a.hasClass("acym_select2_ajax")){var i=a.attr("data-ctrl");i||(i="dynamics");var o=a.attr("data-task");o||(o="trigger");var e=AJAX_URL_ACYM+"&ctrl="+i+"&task="+o+"&id="+encodeURIComponent(_),n=a.attr("data-params"),c=t.acym_parseJson(n);e+="&"+t.param(c),t.get(e,function(i){i=t.acym_parseJson(i);var o=new Option(i.value,_,!1,!1);a.append(o).trigger("change")})}else a.is(":checkbox")||null!=a.attr("data-switch")?a.is(":checkbox")&&1==_?a.prop("checked",!0):null!=a.attr("data-switch")&&a.val()!=_&&a.closest(".medium-3").find(".cell.switch-label").click():a.val(_);void 0!==a.attr("data-rs")&&""!==_&&(-1!=_.indexOf("]")?t('input[data-open="'+a.attr("data-rs")+'"]').val(_):t('input[data-open="'+a.attr("data-rs")+'"]').val(moment.unix(_).format("DD MMM YYYY HH:mm")))}function m(){1==t("#adminAutomation").val()&&t(document).find('[data-open*="acy_add_queuetime"]').attr("disabled","disabled"),t.setDatePickerGlobal(),t.setRSDateChoice(),function(){var a=t("#acym__automation__actions__json");if(!a.length)return;var _=JSON.parse(a.val());t(".acym__automation__actions__select").off("change.loadoptions").on("change.loadoptions",function(){t(this).parent().parent().find(".acym__automation__inserted__action").remove();var a=_[t(this).val()].option.replace(/__and__/g,t(this).closest(".acym__automation__actions__one__action").attr("data-action-number"));t(this).parent().after('<div class="grid-x acym__automation__inserted__action margin-top-1 margin-left-2 grid-margin-x cell acym_vcenter">'+a+"</div>"),1==t("#adminAutomation").val()&&t(this).parent().next().find('[data-open*="acy_add_queuetime"]').attr("disabled","disabled"),t(".acym__select").select2({theme:"foundation",width:"100%"}),t(document).foundation(),t(".reveal-overlay").appendTo("#acym_form"),m();var i=t(this).closest(".acym__automation__actions__one__action").find(".acym__automation__actions__operator__dropdown"),o=t(this).closest(".acym__automation__actions__one__action").find(".acym__automation__actions__fields__dropdown");i.on("change",function(){o.trigger("change")}),o.on("change",function(){var a=t(this).closest(".acym__automation__inserted__action"),_=a.find('[data-action-field="'+t(this).val()+'"]'),o=a.find(".acym__automation__actions__fields__select"),e=a.find(".acym__automation__action__regular-field");_.length>0&&"="===i.val()?(e.attr("name",e.attr("name").replace("acym_action","")).hide(),o.each(function(a){t(this).attr("name",t(this).attr("name").replace("acym_action","")),t(this).closest(".acym__automation__one-field").hide()}),-1===_.attr("name").indexOf("acym_action")&&_.attr("name","acym_action"+_.attr("name")),_.closest(".acym__automation__one-field").show()):(-1===e.attr("name").indexOf("acym_action")&&e.attr("name","acym_action"+e.attr("name")),o.length>0&&o.each(function(){t(this).attr("name",t(this).attr("name").replace("acym_action","")),t(this).closest(".acym__automation__one-field").hide()}),e.show())}),t(this).closest(".acym__automation__actions__one__action").find(".acym__automation__actions__fields__dropdown").trigger("change")})}(),t(".acym__automation__add-action").off("click").on("click",function(){var a=t("#acym__automation__action__number__action");a.val(parseInt(a.val())+1),t(this).before(t("#acym__automation__example").html());var _=t(this).prev();_.closest(".acym__automation__actions__one__action").attr("data-action-number",a.val()),_.find("select").select2({theme:"foundation",width:"100%"}),m()}),t(".acym__automation__delete__one__action").off("click").on("click",function(){t(this).closest(".acym__automation__actions__one__action").remove()}),t.setSubmitButtonGlobal(),t(".acym__automation__actions__mails__select").on("change",function(){"0"!==t(this).val()?t(this).closest(".acym__automation__inserted__action").find('[data-task="createMail"]').html(ACYM_JS_TXT.ACYM_EDIT_MAIL):t(this).closest(".acym__automation__inserted__action").find('[data-task="createMail"]').html(ACYM_JS_TXT.ACYM_CREATE_MAIL)}),t.setResetMail(),t.setTemplateModal(!0)}function s(a){var _=t(a).closest(".acym__automation__group__filter").attr("data-filter-number"),i=t(a).closest(".acym__automation__group__filter"),o=t(a).closest(".acym__automation__inserted__filter").attr("data-and"),e=AJAX_URL_ACYM+"&page=acymailing_automation&ctrl=automation&task=countresults&or="+_+"&and="+o;t("#results_"+o).css("maxHeight","18px").html('<i class="fa fa-circle-o-notch fa-spin"></i>'),t.get(e,t(a).closest("#acym_form").serialize()+"&page=acymailing_automation&ctrl=automation&task=countresults&or="+_+"&and="+o).done(function(a){t("#results_"+o).css("maxHeight","").html(a)}).fail(function(){t("#results_"+o).css("maxHeight","").html(ACYM_JS_TXT.ACYM_ERROR)}),l(i)}function l(a){var _=a.attr("data-filter-number"),i=a.find(".acym__automation__or__total__result"),o=AJAX_URL_ACYM+"&page=acymailing_automation&ctrl=automation&task=countResultsOrTotal&or="+_;i.html('<i class="fa fa-circle-o-notch fa-spin"></i>'),t.get(o,a.closest("#acym_form").serialize()+"&page=acymailing_automation&ctrl=automation&task=countResultsOrTotal&or="+_).done(function(t){i.html(t)}).fail(function(){i.html(ACYM_JS_TXT.ACYM_ERROR)})}t(".acym__automations__filter__tags").select2({theme:"foundation",width:"100%"}),t(".acym__select").select2({theme:"foundation",width:"100%"}),t("#acym__automation__info__desc__button").off("click").on("click",function(){var a=t('[name="automation[description]"]');a.is(":visible")?(a.hide(),t(this).find("i").removeClass("acymicon-keyboard_arrow_up").addClass("acymicon-keyboard_arrow_down")):(a.show(),t(this).find("i").removeClass("acymicon-keyboard_arrow_down").addClass("acymicon-keyboard_arrow_up"))}),t("#acym__automation__info__choose__trigger__type p").off("click").on("click",function(){t("#acym__automation__trigger__type__input").val(t(this).attr("data-trigger-type")),t(".selected-trigger").removeClass("selected-trigger"),t(this).addClass("selected-trigger"),t(".acym__automation__info__choose__trigger").hide(),t("#acym__automation__info__choose__trigger__"+t(this).attr("data-trigger-type")).show()}),a("classic"),i("classic"),_("classic"),a("action"),i("action"),_("action"),l(t(".acym__automation__select__classic__filter").closest(".acym__automation__group__filter")),n(),function(){var a=t("#conditions");if(a.length){var _=JSON.parse(a.val()),i=_.type_condition,o=0;t.each(_,function(a,_){var e=0;if("type_condition"==a)return!0;0!=o&&t('.acym__automation__conditions__or[data-condition-type="'+i+'"]').click(),t.each(_,function(a,_){0!=e&&t('.acym__automation__group__condition[data-condition-number="'+o+'"]').find('.acym__automation__add-condition[data-condition-type="'+i+'"]').click(),t.each(_,function(a,_){var e=t('.acym__automation__group__condition[data-condition-number="'+o+'"]').find(".acym__automation__select__"+i+"__condition").last();e.val(a),e.trigger("change"),t.each(_,function(_,i){var e=t('[name="acym_condition[conditions]['+o+"]["+t("#acym__automation__conditions__count__and").val()+"]["+a+"]["+_+']"]');r(e,i),e.trigger("change")})}),e++}),o++}),n()}}(),c(),function(){var a=t("#filters");if(a.length){var _=JSON.parse(a.val()),i=_.type_filter,o=0;t.each(_,function(a,_){var e=0;if("type_filter"==a)return!0;0!=o&&t('.acym__automation__filters__or[data-filter-type="'+i+'"]').click(),t.each(_,function(a,_){0!=e&&t('.acym__automation__group__filter[data-filter-number="'+o+'"]').find('.acym__automation__add-filter[data-filter-type="'+i+'"]').click(),t.each(_,function(a,_){var e=t('.acym__automation__group__filter[data-filter-number="'+o+'"]').find(".acym__automation__select__"+i+"__filter").last();e.val(a),e.trigger("change"),t.each(_,function(_,i){var e=t('[name="acym_action[filters]['+o+"]["+t("#acym__automation__filters__count__and").val()+"]["+a+"]["+_+']"]');r(e,i),e.trigger("change")})}),e++}),o++}),c()}}(),m(),function(){var a=t("#actions");if(a.length){var _=JSON.parse(a.val()),i=0;t.each(_,function(a,_){i>0&&t(".acym__automation__add-action").click(),t.each(_,function(a,_){var o=t(".acym__automation__actions__select").last();o.val(a),o.trigger("change"),t.each(_,function(o,e){var n=t('[name="acym_action[actions]['+i+"]["+a+"]["+o+']"]');r(n,e),"acy_add_queue"===a&&"mail_id"===o&&""!==e&&(n.next().html(_.mail_name+'<i class="cursor-pointer acymicon-close acym__color__red acym__automation__action__reset__mail margin-left-1"></i>'),n.prev().html(ACYM_JS_TXT.ACYM_EDIT_MAIL)),n.trigger("change")})}),i++}),m()}}()});